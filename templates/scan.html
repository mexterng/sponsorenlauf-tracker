<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Scan</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        .message {
            padding: 5px;
            font-weight: bold;
            color: green;
        }

        .error {
            padding: 5px;
            font-weight: bold;
            color: red;
        }

        .cooldown {
            padding: 5px;
            font-weight: bold;
            color: orange;
        }
    </style>
    <script>
        window.onload = function () {
            const scannerInput = document.getElementById("scanner_id");
            const codeInput = document.getElementById("code");
            const form = document.getElementById("scanForm");
            const message = document.getElementById("message");

            // Lade gespeicherten Scannername
            const savedScanner = localStorage.getItem("scanner_id");
            if (savedScanner) scannerInput.value = savedScanner;

            codeInput.focus();

            form.addEventListener("submit", function (e) {
                e.preventDefault();

                const code = codeInput.value.trim();
                const scanner = scannerInput.value.trim();
                if (!code || !scanner) return;

                localStorage.setItem("scanner_id", scanner);

                fetch("/scan-client", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `code=${encodeURIComponent(
                        code
                    )}&scanner_id=${encodeURIComponent(scanner)}`,
                })
                    .then((response) => {
                        if (!response.ok) {
                            return response.json().then((errorData) => {
                                throw { status: response.status, data: errorData };
                            });
                        }
                        return response.json();
                    })
                    .then((data) => {
                        // Neue Meldung oben hinzufügen
                        const msgDiv = document.createElement("div");
                        msgDiv.className = "message";
                        msgDiv.textContent = `Scan erfasst: ${data.firstname || "?"} ${data.lastname || ""
                            } ${data.class || "?"} (${data.code || ""})`;
                        messageContainer.prepend(msgDiv);

                        // Nach 10 Sekunden Meldung entfernen
                        setTimeout(() => msgDiv.remove(), 10000);

                        codeInput.value = "";
                        codeInput.focus();
                    })
                    .catch((error) => {
                        console.log(error.status);
                        if (error.status === 404) {
                            // Neue Meldung oben hinzufügen
                            const msgDiv = document.createElement("div");
                            msgDiv.className = "error";
                            msgDiv.textContent = `Scan fehlgeschlagen: Code ${error.data.code || ""
                                } nicht gefunden!`;
                            messageContainer.prepend(msgDiv);

                            // Nach 10 Sekunden Meldung entfernen
                            setTimeout(() => msgDiv.remove(), 10000);

                            codeInput.value = "";
                            codeInput.focus();
                        } else if (error.status === 429) {
                            // Neue Meldung oben hinzufügen
                            const msgDiv = document.createElement("div");
                            msgDiv.className = "cooldown";
                            msgDiv.textContent = `Scan fehlgeschlagen: Letzter Scan von ${error.data.firstname || "?"
                                } ${error.data.lastname || ""} ${error.data.class || "?"} (${error.data.code || ""
                                }) ist noch keine 120 Sekunden her!`;
                            messageContainer.prepend(msgDiv);

                            // Nach 10 Sekunden Meldung entfernen
                            setTimeout(() => msgDiv.remove(), 10000);

                            codeInput.value = "";
                            codeInput.focus();
                        } else {
                            alert("Verbindungsfehler oder Serverproblem");
                            console.error(error);
                        }
                    });
            });
        };
    </script>
</head>

<body>
    {% include "navbar_back.html" %}
    <h2>Scan</h2>
    <form id="scanForm">
        <label for="scanner_id">Scanner-Name:</label>
        <input type="text" id="scanner_id" name="scanner_id" required /><br /><br />

        <label for="code">Code:</label>
        <input type="text" id="code" name="code" required autofocus /><br /><br />

        <button type="submit">Senden</button>
    </form>

    <div id="messageContainer"></div>
</body>

</html>